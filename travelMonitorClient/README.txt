Προγραμματισμός Συστήματος - 3η εργασία - Εαρινό Εξάμηνο 2021

********************************
  Οργάνωση Φακέλων και Αρχείων
********************************

> monitor
    > relations
    > tools
    monitor_main.c
> mylib
    > BloomFilter
    > CyclicBuffer
    > Date
    > HashTable
    > IPC
    > LinkedList
    > SkipList
> src
    > relations
    > tools
    - main.c
> input_dir
- Makefile

*****************************
  Μεταγλώττιση και Εκτέλεση
*****************************

Πρόγραμμα:
Στον κεντρικό φάκελο που βρίσκεται το Makefile, η μεταγλώττιση γίνεται με την εντολή make.
Τα object files αποθηκεύονται στον φάκελο build που δημιουργείται.
Ο φάκελος input_dir πρέπει αν βρίσκεται στον κεντρικό κατάλογο.
Το εκτελέσιμο παράγεται στον κεντρικό φάκελο και τρέχει με την εντολή:

./travelMonitorClient –m numMonitors -b socketBufferSize -c cyclicBufferSize -s
  sizeOfBloom -i input_dir -t numThreads

*****************************
  Υλοποίηση Δομών Δεδομένων
*****************************

Τα LinkedList, SkipList, HashTable, Date, BloomFilter, IPC στον φάκελο mylib είναι τα ίδια 
που έχουν χρησιμοποιηθεί στην 1η και 2η εργασία ΣυσΠρο.

> mylib > CyclicBuffer > CyclicBuffer.h/.c
Η δομή του cyclic buffer που συγκρατά έναν πίνακα με τα δεδομένα, το μέγεθος του πίνακα, start/end μεταβλητές
που λειτουργούν ως δείκτες θέσεων του πίνακα δεδομένων υποδεικνύοντας την αρχή και το τέλος αντίστοιχα 
των θέσεων με δεδομένα, μια μεταβλητή count που είναι ο αριθμός των στοιχείων που βρίσκονται στο buffer 
την τρέχουσα στιγμή και μια μεταβλητή total που μετρά το συνολικό πλήθος στοιχείων που έχουν εισέλθει και 
εξέλθει από το buffer. Η μεταβλητή total χρησιμοποιείται ως ένδειξη στο αρχικό thread ότι όλα τα αρχεία
που περίμενε να διαβαστούν, έχουν διαβαστεί και άρα να συνεχίσει την εκτέλεση εντολών. Εσωτερικά στις 
συναρτήσεις της δομής του cyclic buffer, δεν γίνεται διαχείριση τυχόν mutexes/condition variables ώστε να 
είναι επαναχρησιμοποιήσιμη ως δομή πέρα από τα πλαίσια του μαθήματος. Επομένως, για τη τρέχουσα εργασία,
πριν και μετά από κάθε κλήση συνάρτησης του cyclic buffer, γίνεται κατάλληλη διαχείριση των mutexes/
condition variables. Αναλυτικά σχόλια στον κώδικα.

***********************
  Σχέσεις - relations
***********************

> src > relations >  country_requests.h/.c
Η δομή που συγκρατά το όνομα της χώρας και λίστες accepted_requests/rejected_requests που 
αποτελούνται από τις ημερομηνίες για τις οποίες έγιναν αιτήματα ταξιδιού και έγιναν δεκτές ή απορρίφθηκαν 
αντίστοιχα για την συγκεκριμένη χώρα.
Αναλυτικά σχόλια στον κώδικα.

> src > relations >  virus_bloom.h/.c
Η δομή που συγκρατά το όνομα του ιού, δείκτη σε BloomFilter για τον ιό και λίστες total_accepted_requests/
total_rejected_requests που αποτελούνται από τις ημερομηνίες για τις οποίες έγιναν αιτήματα ταξιδιού και 
έγιναν δεκτές ή απορρίφθηκαν αντίστοιχα για τον συγκεκριμένο ιό.
Αναλυτικά σχόλια στον κώδικα.

> src > relations > monitor.h/.c
Η δομή μιας διεργασίας - παιδί - monitor που συγκρατά το PID, το index για τους πίνακες που διατηρούν τα 
file descriptors των διεργασιών για read και write πάνω από socket, μια λίστα με τις χώρες που διαχειρίζεται 
το monitor, ένα HashTable από virus_bloom structs και τους μετρητές για total_accepted/total_rejected αιτήματα.
Αναλυτικά σχόλια στον κώδικα.

> monitor > relations > country.h/.c
Η δομή της χώρας που συγκρατά το όνομα της χώρας.

> monitor > relations > citizenRecord.h/.c
Η δομή του πολίτη. Συγκρατά citizenID, firstname, lastname, age και τη χώρα που είναι δείκτης στη δομή country!
Αναλυτικά σχόλια στον κώδικα.

> monitor > relations > virus.h/.c
Υπάρχουν δύο δομές.
Δομή vaccinated: Συγκρατά δείκτη στην δομή του πολίτη citizen και δείκτη στην ημερομηνία date.
Δομή virus: Συγκρατά το όνομα του ιού, δείκτη σε SkipList για τους vaccinated_persons του ιού, 
δείκτη σε SkipList για τους not_vaccinated_persons του ιού και δείκτη σε BloomFilter.
Αναλυτικά σχόλια στον κώδικα.

********************
  Εργαλεία - Tools
********************

> src > tools > utils.h/.c 
Οι κύριες συναρτήσεις:

  -aggregation:
    Αποτελεί τον κύριο κορμό της εφαρμογής. Αρχικά, διαβάζει από τον φάκελο input_dir τις χώρες που περιέχει
    και τις αποθηκεύει σε έναν πίνακα που ταξινομεί αλφαβητικά προκειμένου να γίνει το διαμοίρασμα των χωρών
    που θα διαχειριστεί κάθε monitor με RR alphabetically τρόπο. Δημιουργεί ένα hash table από monitor structs
    με κλειδί ένα μοναδικό index για αυτό το monitor (monitor_idx), το οποίο είναι ίδιο με το πεδίο fd_index 
    του monitor struct (το index για τους πίνακες που διατηρούν τα  file descriptors των διεργασιών για read 
    και write πάνω από socket) και διαμοιράζει τα ονόματα χωρών στα monitors. Στη συνέχεια, δημιουργεί τις 
    διεργασίες - παιδιά - monitors και τα sockets, ένα socket αντιστοιχεί σε κάθε παιδί για επικοινωνία με 
    την διεργασία - πατέρα. Ακολουθεί η διαδικασία για socket connection. Καλεί την συνάρτηση get_bloom_filters
    για να λάβει τα bloom filters από τις διεργασίες - παιδιά και αμέσως μετά καλεί την execute_queries 
    που εκτελεί τα ερώτηματα του χρήστη. Μόλις ο χρήστης δώσει την εντολή /exit, δημιουργείται ο φάκελος LogFiles 
    στον οποίο η διεργασία - γονέα δημιουργεί το log file. Αναλυτικά σχόλια στον κώδικα.

  -get_bloom_filters:
    Η διαδικασία που η διεργασία - γονέα λαμβάνει τα bloom filters που στείλανε οι διεργασίες - παιδιά του.
    Αναλυτικά σχόλια στον κώδικα.


> src > tools > queries.h/.c
  -execute_queries:
    Εκτελεί τα ερωτήματα και καλεί βοηθητικές συναρτήσεις που έχουν υλοποιηθεί στο queries.c .
    Αναλυτικά σχόλια στον κώδικα.   

> monitor > tools > dataStore.h/.c
Δομή dataStore: Συγκρατά τα 3 Hash Tables του monitor:
1) Για τους ιούς: Δέχεται τη δομή virus κι έχει κλειδί το όνομα του ιού (String)
2) Για τις χώρες: Δέχεται τη δομή country κι έχει κλειδί το όνομα της χώρας (String)
3) Για τους πολίτες: Δέχεται τη δομή citizenRecord κι έχει κλεδί το citizenID (Integer)
Κατά τη δημιουργία, τίθενται και οι συναρτήσεις καταστροφής destroy_virus, destroy_country, destroy_citizen.
Συγκρατά επίσης τη πληροφορία sizeOfBloom και το πλήθος των accepted/rejected requests.

> monitor > tools > utils_queries.h/.c
Οι κύριες συναρτήσεις:

  -get_filepaths:
    Η συνάρτηση αυτή λαμβάνει τον πίνακα με τα μονοπάτια των χωρών που θα διαχειριστούν τα 
    threads (path1...pathn) κι επιστρέφει λίστα με τα αρχεία που βρίσκονται μέσα σε αυτά 
    τα μονοπάτια. Αναλυτικά σχόλια στον κώδικα.

  -fileParse_and_buildStructs: 
    Είναι η συνάρτηση που εκτελούν τα threads κατά τη δημιουργία τους. 
    Κάνει το file parsing και ταυτόχρονα "χτίζει" όλες τις δομές. Καλεί την συνάρτηση insertCitizen.
    Διαβάζει τα αρχεία από το cyclic buffer και γίνεται διαχείριση των mutexes/condition variables.
    Τα threads μπλοκάρουν περιμένοντας ο buffer να μην είναι άδειος.
    Αναλυτικά σχόλια στον κώδικα.

  -send_bloomFilters
    Στέλνει τα bloom filters μέσω socket πίσω στην διεργασία πατέρα.

  -queries
    Εκτελεί τα ερωτήματα και καλεί βοηθητικές συναρτήσεις που έχουν υλοποιηθεί στο utils_queries.c .
    Αναλυτικά σχόλια στον κώδικα.

****************************
  Επισημάνσεις - Παραδοχές
****************************

1) Παρέχεται ένας φάκελος inputDir στον κεντρικό φάκελο για διευκόλυνση.

2) Θεωρώ πώς το socketBufferSize δεν μπορεί να είναι κάτω από 4 bytes (https://piazza.com/class/kkx2o2gvper2nj?cid=172_f1)
  προκειμένου να στέλνω το μέγεθος του μηνύματος στα sockets πρώτα.

3) Οι διεργασίες - παιδιά και η διεργασία - γονέας έχουν τους ίδιους μετρητές αιτημάτων που έγιναν
  accepted/rejected. Δηλαδή, η διεργασία - γονέας ενημερώνει κάθε φορά το κατάλληλο monitor για 
  τυχόν αιτήματα που δεν χρειάστηκε να γίνει επικοινωνία μέσω socket για να απαντηθούν.

4) Υποθέτω ότι όλες οι χώρες ελέγχουν για εμβολιασμό κάθε ιό που εισάγει ο χρήστης. Μάλιστα,
  αν αυτός ο ιός δεν προϋπήρχε στην βάση, τότε θα προστεθεί έτσι όπως τον έδωσε ο χρήστης.

5) Η εφαρμογή είναι έτοιμη να δεχτεί εντολές από τον χρήστη όταν στο terminal εκτυπωθεί με 
  πράσινα γράμματα "Enter command: ". Μπορεί να πάρει κάποια δευτερόλεπτα να εμφανιστεί 
  τη πρώτη φορά αυτό κατά την εκτέλεση της εφαρμογής (εξαρτάται από το μέγεθος του bloom filter,
  το πλήθος των εγγραφών και τον αριθμό των διεργασιών - παιδιών).
