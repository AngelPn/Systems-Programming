Αγγελική Παναγοπούλου - 1115201800141
Προγραμματισμός Συστήματος - 3η εργασία - Εαρινό Εξάμηνο 2021

********************************
  Οργάνωση Φακέλων και Αρχείων
********************************

> monitor
    > relations
    > tools
    monitor_main.c
> mylib
    > BloomFilter
    > Date
    > HashTable
    > IPC
    > LinkedList
    > SkipList
> src
    > relations
    > tools
    - main.c
> input_dir
- create_infiles.sh
- inputFile
- Makefile

*****************************
  Μεταγλώττιση και Εκτέλεση
*****************************

Δημιουργία του φακέλου input_dir:
./create_infiles.sh inputFile input_dir numFilesPerDirectory
Το αρχείο inputFile πρέπει να τοποθετηθεί στον κεντρικό φάκελο, όπως δείχνει η αναπαράσταση 
"Οργάνωση Φακέλων και Αρχείων".

Πρόγραμμα:
Στον κεντρικό φάκελο που βρίσκεται το Makefile, η μεταγλώττιση γίνεται με την εντολή make.
Τα object files αποθηκεύονται στον φάκελο build που δημιουργείται.
Το εκτελέσιμο παράγεται στον κεντρικό φάκελο και τρέχει με την εντολή:
./travelMonitor –m numMonitors -b bufferSize -s sizeOfBloom -i input_dir

*****************************
  Υλοποίηση Δομών Δεδομένων
*****************************

Τα LinkedList, SkipList, HashTable, Date, BloomFilter είναι τα ίδια που έχουν χρησιμοποιηθεί στην 
1η εργασία ΣυσΠρο.

> mylib > IPC > ipc.h/.c
Περιέχει τις συναρτήσεις για Inter-Process Communication μεταξύ των διεργασιών πατέρα - παιδί μέσω των 
named pipes. Το πρώτο μήνυμα που θα σταλθεί ή ληφθεί είναι το μέγεθος των δεδομένων.
Το minimum bufferSize είναι 4 bytes γι'αυτόν τον σκοπό. Αναλυτικά σχόλια στον κώδικα.

***********************
  Σχέσεις - relations
***********************

> src > relations >  country_requests.h/.c
Η δομή που συγκρατά το όνομα της χώρας και λίστες accepted_requests/rejected_requests που 
αποτελούνται από τις ημερομηνίες για τις οποίες έγιναν αιτήματα ταξιδιού και έγιναν δεκτές ή απορρίφθηκαν 
αντίστοιχα για την συγκεκριμένη χώρα.
Αναλυτικά σχόλια στον κώδικα.

> src > relations >  virus_bloom.h/.c
Η δομή που συγκρατά το όνομα του ιού, δείκτη σε BloomFilter για τον ιό και λίστες total_accepted_requests/
total_rejected_requests που αποτελούνται από τις ημερομηνίες για τις οποίες έγιναν αιτήματα ταξιδιού και 
έγιναν δεκτές ή απορρίφθηκαν αντίστοιχα για τον συγκεκριμένο ιό.
Αναλυτικά σχόλια στον κώδικα.

> src > relations > monitor.h/.c
Η δομή μιας διεργασίας - παιδί - monitor που συγκρατά το PID, το index για τους πίνακες που διατηρούν τα 
file descriptors των διεργασιών για read και write, μια λίστα με τις χώρες που διαχειρίζεται το monitor, 
ένα HashTable από virus_bloom structs και τους μετρητές για total_accepted/total_rejected αιτήματα.
Αναλυτικά σχόλια στον κώδικα.

> monitor > relations > country.h/.c
Η δομή της χώρας που συγκρατά το όνομα της χώρας.

> monitor > relations > citizenRecord.h/.c
Η δομή του πολίτη. Συγκρατά citizenID, firstname, lastname, age και τη χώρα που είναι δείκτης στη δομή country!
Αναλυτικά σχόλια στον κώδικα.

> monitor > relations > virus.h/.c
Υπάρχουν δύο δομές.
Δομή vaccinated: Συγκρατά δείκτη στην δομή του πολίτη citizen και δείκτη στην ημερομηνία date.
Δομή virus: Συγκρατά το όνομα του ιού, δείκτη σε SkipList για τους vaccinated_persons του ιού, 
δείκτη σε SkipList για τους not_vaccinated_persons του ιού και δείκτη σε BloomFilter.
Αναλυτικά σχόλια στον κώδικα.

********************
  Εργαλεία - Tools
********************

> src > tools > utils.h/.c 
Οι κύριες συναρτήσεις:

  -aggregation:
    Αποτελεί τον κύριο κορμό της εφαρμογής. Δημιουργεί τις διεργασίες - παιδιά - monitors.
    Δημιουργεί τα named pipes τα οποία έχει επιλεγεί να είναι δύο για κάθε διεργασία - παιδί:
    Το ένα θα είναι για να γράφει ο πατέρας και να διαβάζει το παιδί και το άλλο θα είναι για να γράφει το παιδί
    και να διαβάζει ο πατέρας. Διατηρεί τους πίνακες read_fd και write_fd που περιέχουν τα file descriptors 
    των named pipes για διάβασμα και γράψιμο αντίστοιχα με κάθε διεργασία - παιδί. Διατηρεί τον πίνακα 
    monitors_pids που περιέχει τα PIDs των διεργασιών - παιδιών. Συγκρατά ένα HashTable από monitor structs
    με κλειδί τα PIDs των διεργασιών. Κατανέμει τους φακέλους με τις χώρες σε κάθε monitor με RR alphabetically
    τρόπο. Καλεί την συνάρτηση run_queries για την εκτέλεση των εντολών χρήστη. Μόλις σημανθεί /exit ή δοθεί
    σήμα SIGINT/SIGQUIT στη διεργασία - γονέα, ο γονέας κάνει SIGKILL τα παιδιά του, περιμένει να τερματίσουν
    και δημιουργεί τα log files. Αναλυτικά σχόλια στον κώδικα.

  -get_bloom_filters:
    Η διαδικασία που η διεργασία - γονέα λαμβάνει τα bloom filters που στείλανε οι διεργασίες - παιδιά του.
    Αναλυτικά σχόλια στον κώδικα.

  -reborn_child:
    Η διαδικασία αναγέννησης και αντικατάστασης μιας διεργασίας - παιδί που έχει τερματίσει.
    Αναλυτικά σχόλια στον κώδικα.

> src > tools > queries.h/.c
  -run_queries:
    Εκτελεί τα ερωτήματα και καλεί βοηθητικές συναρτήσεις που έχουν υλοποιηθεί στο queries.c .
    Εκεί γίνεται και η διαχείριση των σημάτων SIGINT/SIGQUIT και SIGCHLD.
    Αναλυτικά σχόλια στον κώδικα.   

> monitor > tools > dataStore.h/.c
Δομή dataStore: Συγκρατά τα 3 Hash Tables του monitor:
1) Για τους ιούς: Δέχεται τη δομή virus κι έχει κλειδί το όνομα του ιού (String)
2) Για τις χώρες: Δέχεται τη δομή country κι έχει κλειδί το όνομα της χώρας (String)
3) Για τους πολίτες: Δέχεται τη δομή citizenRecord κι έχει κλεδί το citizenID (Integer)
Κατά τη δημιουργία, τίθενται και οι συναρτήσεις καταστροφής destroy_virus, destroy_country, destroy_citizen.

> monitor > tools > utils_queries.h/.c
Οι κύριες συναρτήσεις:

  -fileParse_and_buildStructs: 
    Κάνει το file parsing και ταυτόχρονα "χτίζει" όλες τις δομές. Καλεί την συνάρτηση insertCitizen.
    Αναλυτικά σχόλια στον κώδικα.

  -send_bloomFilters
    Στέλνει τα bloom filters μέσω named pipe πίσω στην διεργασία πατέρα.

  -queries
    Εκτελεί τα ερωτήματα και καλεί βοηθητικές συναρτήσεις που έχουν υλοποιηθεί στο utils_queries.c .
    Εκεί γίνεται και η διαχείριση των σημάτων SIGINT/SIGQUIT και SIGUSR.
    Αναλυτικά σχόλια στον κώδικα.

****************************
  Επισημάνσεις - Παραδοχές
****************************

1) Παρέχεται ένα αρχείο inputFile στον κεντρικό φάκελο για διευκόλυνση.

2) Για διευκόλυνσή μας, ειπώθηκε στο piazza (https://piazza.com/class/kkx2o2gvper2nj?cid=137_f1) 
  ότι μπορούμε να κάνουμε την εξής παραδοχή: 
  Τα σήματα να στέλνονται από δεύτερο terminal μόνο όταν το πρόγραμμα βρίσκεται σε 
  σταθερή κατάσταση, δηλαδή περιμένει input από τον χρήστη. Έτσι κι εδώ, δεν γίνεται
  διαχείριση των σημάτων όταν μία διεργασία βρίσκεται σε κατάσταση αποστολής/λήψης μηνύματος.

3) Θεωρώ πώς το buffersize δεν μπορεί να είναι κάτω από 4 bytes (https://piazza.com/class/kkx2o2gvper2nj?cid=172_f1)
  προκειμένου να στέλνω το μέγεθος του μηνύματος στα named pipes πρώτα.

4) Όταν πεθαίνει μία διεργασία - παιδί και αναγεννάται, δεν διατηρεί τους τρέχοντες μετρητές
  αιτημάτων που έγιναν accepted/rejected. Δηλαδή, η νέα διεργασία monitor θα μηδενίσει αυτούς τους
  μετρητές. Η πληροφορία αυτή ωστόσο παραμένει στη διεργασία - γονέα.

5) Οι διεργασίες - παιδιά και η διεργασία - γονέας έχουν τους ίδιους μετρητές αιτημάτων που έγιναν
  accepted/rejected (εκτός από τη περίπτωση 4). Δηλαδή, η διεργασία - γονέας ενημερώνει κάθε φορά 
  το κατάλληλο monitor για τυχόν αιτήματα που δεν χρειάστηκε να γίνει επικοινωνία μέσω named pipe 
  για να απαντηθούν.

6) Υποθέτω ότι όλες οι χώρες ελέγχουν για εμβολιασμό κάθε ιό που εισάγει ο χρήστης. Μάλιστα,
  αν αυτός ο ιός δεν προϋπήρχε στην βάση, τότε θα προστεθεί έτσι όπως τον έδωσε ο χρήστης.

7) Η εφαρμογή είναι έτοιμη να δεχτεί εντολές από τον χρήστη όταν στο terminal εκτυπωθεί με 
  πράσινα γράμματα "Enter command: ". Μπορεί να πάρει κάποια δευτερόλεπτα να εμφανιστεί 
  τη πρώτη φορά αυτό κατά την εκτέλεση της εφαρμογής (εξαρτάται από το μέγεθος του bloom filter,
  το πλήθος των εγγραφών και τον αριθμό των διεργασιών - παιδιών).
